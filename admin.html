<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tiro+Devanagari+Hindi:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        :root { 
            --primary-color: #4a90e2;
            --danger-color: #d9534f;
            --success-color: #5cb85c;
            --warning-color: #f0ad4e;
            --info-color: #5bc0de;
            --light-gray-color: #f8f9fa;
            --dark-gray-color: #343a40;
            --text-color: #495057;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        body { 
            font-family: 'Kokila', 'Tiro Devanagari Hindi', sans-serif; 
            background-color: var(--light-gray-color); 
            color: var(--text-color); 
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container { 
            background-color: #fff; 
            padding: 30px 40px; 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            width: 100%;
            max-width: 1200px; 
            margin: 20px auto;
            box-sizing: border-box;
        }

        #login-container {
            max-width: 450px;
            margin-top: 5vh;
        }

        h1, h2, h3 { 
            color: var(--dark-gray-color); 
            text-align: center; 
            margin-bottom: 25px;
        }
        
        h1 { font-weight: 600; }
        h2 { font-weight: 500; }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .panel-header h1, .panel-header h2 {
            margin: 0;
            text-align: left;
        }
        
        .panel-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        #admin-panel { display: none; }
        
        input, select { 
            width: 100%; 
            padding: 12px 15px; 
            margin-bottom: 18px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-family: 'Kokila', 'Tiro Devanagari Hindi', sans-serif;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        button { 
            padding: 10px 20px; 
            border-radius: 8px; 
            border: none; 
            color: white; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 500;
            font-family: 'Kokila', 'Tiro Devanagari Hindi', sans-serif;
            transition: opacity 0.2s, transform 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        button:hover:not(:disabled) {
            opacity: 0.85;
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #9c9c9c;
        }
        
        .btn-login { background-color: var(--primary-color); width: 100%; padding: 12px;}
        .btn-logout { background-color: var(--danger-color); }
        .btn-delete { background-color: var(--danger-color); }
        .btn-edit { background-color: var(--warning-color); }
        .btn-rank { background-color: var(--info-color); }
        .btn-save { background-color: var(--success-color); }
        .btn-cancel { background-color: #6c757d; }
        .btn-export-notify { background-color: var(--success-color); }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; 
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            min-width: 800px;
        }

        th, td { 
            border-bottom: 1px solid var(--border-color); 
            padding: 15px; 
            text-align: left; 
            vertical-align: middle;
            white-space: nowrap;
        }

        th { 
            background-color: var(--light-gray-color);
            color: var(--dark-gray-color);
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #fdfdfd;
        }
        
        .suspect-entry { 
            background-color: #fffaf0;
            border-left: 4px solid var(--warning-color);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        #error-message { 
            color: var(--danger-color); 
            text-align: center; 
            margin-bottom: 15px; 
            min-height: 1.2em;
        }
        
        /* Modal for Delete All Confirmation */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 30px; border: none; width: 90%; max-width: 550px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-actions { text-align: right; margin-top: 25px; }
        
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        #pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color); flex-wrap: wrap; gap: 15px; }
        #pagination-controls .nav-buttons { display: flex; gap: 10px; }
        #pagination-controls button { background-color: var(--primary-color); }
        #page-info { font-weight: 500; color: var(--text-color); flex-shrink: 0; }
        
        #delete-status {
            color: var(--danger-color);
            font-weight: 500;
            text-align: center;
            margin-top: 15px;
        }
        
        .modal h3 { margin-bottom: 20px; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            .panel-header { flex-direction: column; align-items: flex-start; }
            .panel-actions { width: 100%; }
            .panel-actions button { flex-grow: 1; }
            #pagination-controls { flex-direction: column; gap: 20px; }
        }
    </style>
</head>
<body>

    <div id="login-container">
        <div class="container" id="login-form">
            <h2>üîí Admin Login</h2>
            <div id="error-message"></div>
            <input type="email" id="email" placeholder="‡§à‡§Æ‡•á‡§≤" required>
            <input type="password" id="password" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°" required>
            <button id="loginBtn" class="btn-login">‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
    </div>

    <div id="admin-panel">
        <div class="container">
            <div class="panel-header">
                <h1>üõ°Ô∏è Admin Dashboard</h1>
                <div class="panel-actions">
                    <button id="generateRankList" class="btn-rank"><i class="fas fa-file-csv"></i> ‡§∞‡•à‡§Ç‡§ï ‡§∏‡•Ç‡§ö‡•Ä (CSV)</button>
                    <button id="deleteAllBtn" class="btn-delete"><i class="fas fa-trash"></i> ‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§π‡§ü‡§æ‡§è‡§Å</button>
                    <button id="logoutBtn" class="btn-logout"><i class="fas fa-sign-out-alt"></i> ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü</button>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table id="adminDataTable">
                    <thead>
                        <tr>
                            <th>‡§∞‡•à‡§Ç‡§ï</th>
                            <th>‡§∞‡•ã‡§≤ ‡§®‡§Ç‡§¨‡§∞</th>
                            <th>‡§®‡§æ‡§Æ</th>
                            <th>‡§∏‡§π‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® (P1)</th>
                            <th>‡§ó‡§≤‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® (P1)</th>
                            <th>‡§∏‡§π‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® (P2)</th>
                            <th>‡§ó‡§≤‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® (P2)</th>
                            <th>‡§ï‡•Å‡§≤ ‡§Ö‡§Ç‡§ï</th>
                            <th>‡§∂‡•ç‡§∞‡•á‡§£‡•Ä</th>
                            <th>‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div id="pagination-controls">
                <div class="nav-buttons"><button id="prev-page" disabled><i class="fas fa-arrow-left"></i> ‡§™‡§ø‡§õ‡§≤‡§æ</button></div>
                <span id="page-info">‡§™‡•á‡§ú 1</span>
                <div class="nav-buttons"><button id="next-page" disabled>‡§Ö‡§ó‡§≤‡§æ <i class="fas fa-arrow-right"></i></button><button id="last-page" disabled>‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§™‡•á‡§ú <i class="fas fa-fast-forward"></i></button></div>
            </div>
        </div>

        <div class="container">
            <div class="panel-header">
                <h2>üîî ‡§Ö‡§ß‡§ø‡§∏‡•Ç‡§ö‡§®‡§æ ‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§æ‡§á‡§¨‡§∞</h2>
                <div class="panel-actions">
                    <button id="exportNotifyBtn" class="btn-export-notify"><i class="fas fa-file-csv"></i> ‡§à‡§Æ‡•á‡§≤ ‡§∏‡•Ç‡§ö‡•Ä (CSV)</button>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="notificationsTable">
                    <thead>
                        <tr>
                            <th style="width: 10%;">‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï</th>
                            <th>‡§à‡§Æ‡•á‡§≤ ‡§Ü‡§à‡§°‡•Ä</th>
                            <th style="width: 25%;">‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§æ‡§á‡§¨ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§§‡§ø‡§•‡§ø</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="3" style="text-align:center;">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h3><i class="fas fa-edit"></i> ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç</h3>
            <form id="editForm">
                <input type="hidden" id="editDocId">
                <label for="rollNumberEdit">‡§∞‡•ã‡§≤ ‡§®‡§Ç‡§¨‡§∞:</label><input type="text" id="rollNumberEdit" required>
                <label for="studentNameEdit">‡§®‡§æ‡§Æ:</label><input type="text" id="studentNameEdit" required>
                <label for="paper1CorrectEdit">‡§™‡•á‡§™‡§∞ 1 ‡§ï‡•á ‡§∏‡§π‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§®:</label><input type="number" id="paper1CorrectEdit" min="0" max="100" required>
                <label for="paper1IncorrectEdit">‡§™‡•á‡§™‡§∞ 1 ‡§ï‡•á ‡§ó‡§≤‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®:</label><input type="number" id="paper1IncorrectEdit" min="0" max="100" required>
                <label for="paper2CorrectEdit">‡§™‡•á‡§™‡§∞ 2 ‡§ï‡•á ‡§∏‡§π‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§®:</label><input type="number" id="paper2CorrectEdit" min="0" max="100" required>
                <label for="paper2IncorrectEdit">‡§™‡•á‡§™‡§∞ 2 ‡§ï‡•á ‡§ó‡§≤‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®:</label><input type="number" id="paper2IncorrectEdit" min="0" max="100" required>
                <label for="categoryEdit">‡§∂‡•ç‡§∞‡•á‡§£‡•Ä:</label><select id="categoryEdit" required><option value="GENERAL">GENERAL</option><option value="OBC">OBC</option><option value="EWS">EWS</option><option value="MBC">MBC</option><option value="SC">SC</option><option value="ST">ST</option></select>
                <label for="areaEdit">‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞:</label><select id="areaEdit" required><option value="TSP">TSP</option><option value="NON TSP">NON TSP</option></select>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()"><i class="fas fa-times"></i> ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                    <button type="submit" class="btn-save"><i class="fas fa-save"></i> ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Modal for Delete All Confirmation -->
    <div id="deleteAllModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDeleteAllModal()">&times;</span>
            <h3>‚ö†Ô∏è ‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§π‡§ü‡§æ‡§è‡§Å</h3>
            <p>‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§∏‡§≠‡•Ä ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ø‡§π ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•Ç‡§∞‡•ç‡§µ‡§µ‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä‡•§</p>
            <p id="delete-status"></p>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeDeleteAllModal()"><i class="fas fa-times"></i> ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                <button type="button" class="btn-delete" id="confirmDeleteBtn"><i class="fas fa-trash"></i> ‡§π‡§æ‡§Å, ‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§π‡§ü‡§æ‡§è‡§Å</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBDHe8N3RzI5kIDg2qmHc4VtmnNpyv_XNM",
            authDomain: "akashsodh-libra.firebaseapp.com",
            projectId: "akashsodh-libra",
            storageBucket: "akashsodh-libra.firebasestorage.app",
            messagingSenderId: "25252360194",
            appId: "1:25252360194:web:5546d30f768c4ca2b0771b",
            measurementId: "G-NP7BSMH4WF"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const studentsCollection = db.collection('students');
        const notificationsCollection = db.collection('notifications');

        // DOM Elements
        const loginContainer = document.getElementById('login-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const errorMessage = document.getElementById('error-message');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        
        // --- Event Listeners ---
        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', () => auth.signOut());
        editForm.addEventListener('submit', saveChanges);
        document.getElementById('generateRankList').addEventListener('click', generateRankListCSV);
        document.getElementById('exportNotifyBtn').addEventListener('click', generateNotificationsCSV);
        document.getElementById('deleteAllBtn').addEventListener('click', showDeleteAllModal);
        document.getElementById('confirmDeleteBtn').addEventListener('click', deleteAllEntries);
        
        // Auth State Logic
        auth.onAuthStateChanged(user => {
            // Check for the specific admin UID
            if (user && user.uid === 'wXSOObASFbb4O5pQd7hnWmPSH5V2') {
                loginContainer.style.display = 'none';
                adminPanel.style.display = 'block';
                initializeAdminView();
            } else {
                loginContainer.style.display = 'block';
                adminPanel.style.display = 'none';
            }
        });
        
        async function initializeAdminView() {
            // This function now loads both student marks and notification subscribers
            loadStudentMarks();
            loadNotificationSubscribers();
        }

        async function loadNotificationSubscribers() {
            const tableBody = document.getElementById('notificationsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>';
            try {
                const snapshot = await notificationsCollection.orderBy('createdAt', 'desc').get();
                tableBody.innerHTML = '';
                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">‡§ï‡•ã‡§à ‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§æ‡§á‡§¨‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</td></tr>';
                    return;
                }
                snapshot.docs.forEach((doc, index) => {
                    const data = doc.data();
                    const row = tableBody.insertRow();
                    const date = data.createdAt ? data.createdAt.toDate().toLocaleDateString('hi-IN', { day: 'numeric', month: 'long', year: 'numeric' }) : 'N/A';
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${data.email}</td>
                        <td>${date}</td>
                    `;
                });
            } catch (error) {
                console.error("Error loading notification subscribers:", error);
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:red;">‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§æ‡§á‡§¨‡§∞ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ (‡§∏‡§π‡•Ä ‡§™‡§∞‡§Æ‡§ø‡§∂‡§® ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç)</td></tr>';
            }
        }
        
        async function generateNotificationsCSV() {
            let csvContent = "‡§ï‡•ç‡§∞‡§Æ‡§æ‡§Ç‡§ï,‡§à‡§Æ‡•á‡§≤,‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§æ‡§á‡§¨ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§§‡§ø‡§•‡§ø\n";
            try {
                const snapshot = await notificationsCollection.orderBy('createdAt', 'desc').get();
                snapshot.docs.forEach((doc, index) => {
                    const data = doc.data();
                    const date = data.createdAt ? data.createdAt.toDate().toISOString().split('T')[0] : '';
                    csvContent += `${index + 1},${data.email},${date}\n`;
                });
                downloadCSV(csvContent, "notification_subscribers.csv");
            } catch (error) {
                console.error("Error generating notifications CSV:", error);
                alert("‡§à‡§Æ‡•á‡§≤ ‡§∏‡•Ç‡§ö‡•Ä ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§");
            }
        }


        // --- EXISTING STUDENT MARKS LOGIC (Refactored into its own function) ---
        // Pagination State
        const ITEMS_PER_PAGE = 1000;
        let currentPage = 1;
        let lastVisible = null;
        let firstVisible = null;
        let totalPages = 1;
        let totalCount = 0;

        async function loadStudentMarks() {
            const tableBody = document.getElementById('adminDataTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">‡§ï‡•Å‡§≤ ‡§°‡•á‡§ü‡§æ ‡§ï‡•Ä ‡§ó‡§£‡§®‡§æ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</td></tr>';
            try {
                const snapshot = await studentsCollection.get();
                totalCount = snapshot.size;
                totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE) || 1;
                
                currentPage = 1;
                lastVisible = null;
                firstVisible = null;
                renderStudentPage();

            } catch(e) {
                 tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§</td></tr>';
                 console.error("Error getting total count:", e);
            }
        }

        async function renderStudentPage(direction = 'initial') {
            const tableBody = document.getElementById('adminDataTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td></tr>';
            let query;
            const baseQuery = studentsCollection.orderBy('totalMarks', 'desc');

            if (direction === 'next' && lastVisible) { query = baseQuery.startAfter(lastVisible).limit(ITEMS_PER_PAGE); } 
            else if (direction === 'prev') { query = baseQuery.endBefore(firstVisible).limitToLast(ITEMS_PER_PAGE); } 
            else if (direction === 'last_page') { const itemsOnLastPage = totalCount % ITEMS_PER_PAGE || ITEMS_PER_PAGE; query = studentsCollection.orderBy('totalMarks', 'asc').limit(itemsOnLastPage); }
            else { query = baseQuery.limit(ITEMS_PER_PAGE); }
            
            try {
                const snapshot = await query.get();
                tableBody.innerHTML = '';
                
                if (snapshot.empty) { tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</td></tr>'; updatePaginationButtons(); return; }
                
                let docs = snapshot.docs;
                if (direction === 'last_page') { docs.reverse(); }

                firstVisible = docs[0];
                lastVisible = docs[docs.length - 1];

                const startingRank = (currentPage - 1) * ITEMS_PER_PAGE + 1;
                docs.forEach((doc, index) => {
                    const student = doc.data();
                    const docId = doc.id;
                    const isSuspect = !student.name || student.name.toLowerCase().trim() === 'test' || parseFloat(student.totalMarks) < 100 || parseFloat(student.totalMarks) > 400;
                    const row = tableBody.insertRow();
                    if (isSuspect) row.classList.add('suspect-entry');
                    row.innerHTML = `<td>${startingRank + index}</td><td>${student.rollNumber || 'N/A'}</td><td>${student.name || 'N/A'}</td><td>${student.correct1 || 'N/A'}</td><td>${student.incorrect1 || 'N/A'}</td><td>${student.correct2 || 'N/A'}</td><td>${student.incorrect2 || 'N/A'}</td><td><strong>${student.totalMarks}</strong></td><td>${student.category} - ${student.area}</td><td class="action-buttons"><button class="btn-edit" onclick='openEditModal("${docId}")'><i class="fas fa-pencil-alt"></i></button><button class="btn-delete" onclick="deleteEntry('${docId}')"><i class="fas fa-trash"></i></button></td>`;
                });
                
                updatePaginationButtons();
            } catch (error) {
                console.error("‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§</td></tr>';
            }
        }
        
        function updatePaginationButtons() {
            document.getElementById('page-info').textContent = `‡§™‡•á‡§ú ${currentPage} / ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            document.getElementById('last-page').disabled = currentPage === totalPages;
        }

        document.getElementById('next-page').addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderStudentPage('next'); } });
        document.getElementById('prev-page').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderStudentPage('prev'); } });
        document.getElementById('last-page').addEventListener('click', () => { if(currentPage < totalPages) { currentPage = totalPages; renderStudentPage('last_page'); } });

        // Other helper functions
        function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            errorMessage.textContent = '';
            auth.signInWithEmailAndPassword(email, password).catch(error => { errorMessage.textContent = '‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§à‡§Æ‡•á‡§≤ ‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°‡•§'; });
        }
        
        async function openEditModal(docId) { 
            try { 
                const docRef = studentsCollection.doc(docId); 
                const doc = await docRef.get(); 
                if (!doc.exists) return; 
                const student = doc.data(); 
                document.getElementById('editDocId').value = docId; 
                document.getElementById('rollNumberEdit').value = student.rollNumber || ''; 
                document.getElementById('studentNameEdit').value = student.name; 
                document.getElementById('paper1CorrectEdit').value = student.correct1; 
                document.getElementById('paper1IncorrectEdit').value = student.incorrect1; 
                document.getElementById('paper2CorrectEdit').value = student.correct2; 
                document.getElementById('paper2IncorrectEdit').value = student.incorrect2; 
                document.getElementById('categoryEdit').value = student.category; 
                document.getElementById('areaEdit').value = student.area; 
                editModal.style.display = 'block'; 
            } catch (error) { 
                console.error("‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error); 
            } 
        }
        function closeEditModal() { editModal.style.display = 'none'; }
        window.onclick = function(event) { if (event.target == editModal || event.target == deleteAllModal) { event.target.style.display = 'none'; } }

        async function saveChanges(e) { 
            e.preventDefault(); 
            const docId = document.getElementById('editDocId').value; 
            const paper1Correct = parseInt(document.getElementById('paper1CorrectEdit').value);
            const paper1Incorrect = parseInt(document.getElementById('paper1IncorrectEdit').value);
            const paper2Correct = parseInt(document.getElementById('paper2CorrectEdit').value);
            const paper2Incorrect = parseInt(document.getElementById('paper2IncorrectEdit').value);

            // Calculate total marks based on new formula
            const paper1Marks = (paper1Correct * 2) - (paper1Incorrect * (2/3));
            const paper2Marks = (paper2Correct * 2) - (paper2Incorrect * (2/3));
            const totalMarks = Math.max(0, paper1Marks + paper2Marks);

            const updatedData = { 
                rollNumber: document.getElementById('rollNumberEdit').value.trim(), 
                name: document.getElementById('studentNameEdit').value.trim(), 
                correct1: paper1Correct,
                incorrect1: paper1Incorrect,
                correct2: paper2Correct,
                incorrect2: paper2Incorrect,
                paper1: paper1Marks.toFixed(2), 
                paper2: paper2Marks.toFixed(2), 
                totalMarks: totalMarks.toFixed(2),
                category: document.getElementById('categoryEdit').value, 
                area: document.getElementById('areaEdit').value, 
            }; 
            try { 
                await studentsCollection.doc(docId).update(updatedData); 
                closeEditModal(); 
                loadStudentMarks(); 
            } catch (error) { 
                console.error("‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error); 
                alert("‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§"); 
            } 
        }
        function deleteEntry(docId) { if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) { studentsCollection.doc(docId).delete().then(() => { loadStudentMarks(); }).catch(error => alert("‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à: " + error.message)); } }
        
        function downloadCSV(csvContent, fileName) { const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", fileName); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        
        // --- NEW: CSV Export for new data model ---
        function generateRankListCSV() { 
            let csvContent = "‡§∞‡•à‡§Ç‡§ï,‡§∞‡•ã‡§≤ ‡§®‡§Ç‡§¨‡§∞,‡§®‡§æ‡§Æ,‡§∏‡§π‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® (‡§™‡•á‡§™‡§∞ 1),‡§ó‡§≤‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® (‡§™‡•á‡§™‡§∞ 1),‡§∏‡§π‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® (‡§™‡•á‡§™‡§∞ 2),‡§ó‡§≤‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® (‡§™‡•á‡§™‡§∞ 2),‡§ï‡•Å‡§≤ ‡§Ö‡§Ç‡§ï,‡§∂‡•ç‡§∞‡•á‡§£‡•Ä,‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞\n"; 
            studentsCollection.orderBy('totalMarks', 'desc').get().then(snapshot => { 
                snapshot.docs.forEach((doc, index) => { 
                    const s = doc.data(); 
                    const rollNumber = s.rollNumber || 'N/A';
                    const name = `"${s.name.replace(/"/g, '""')}"`; 
                    csvContent += `${index + 1},${rollNumber},${name},${s.correct1},${s.incorrect1},${s.correct2},${s.incorrect2},${s.totalMarks},${s.category},${s.area}\n`; 
                }); 
                downloadCSV(csvContent, "merit_list.csv"); 
            }); 
        }
        
        // --- NEW: Delete All Logic ---
        const deleteAllModal = document.getElementById('deleteAllModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const deleteStatus = document.getElementById('delete-status');
        
        function showDeleteAllModal() {
            deleteAllModal.style.display = 'block';
            deleteStatus.textContent = '';
        }
        
        function closeDeleteAllModal() {
            deleteAllModal.style.display = 'none';
        }

        async function deleteAllEntries() {
            confirmDeleteBtn.disabled = true;
            deleteStatus.textContent = '‡§°‡•á‡§ü‡§æ ‡§π‡§ü‡§æ ‡§∞‡§π‡§æ ‡§π‡•à... ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...';
            
            try {
                let snapshot;
                // Delete documents in a loop because Firestore delete() is not for collections.
                do {
                    snapshot = await studentsCollection.limit(500).get(); // Batch size
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                } while (snapshot.docs.length > 0);
                
                deleteStatus.textContent = '‚úÖ ‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à!';
                loadStudentMarks(); // Refresh the table
                setTimeout(closeDeleteAllModal, 3000);
            } catch (error) {
                console.error("Error deleting all documents:", error);
                deleteStatus.textContent = '‚ùå ‡§°‡•á‡§ü‡§æ ‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§';
            } finally {
                confirmDeleteBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
